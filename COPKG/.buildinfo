#product-info  {
    product-name: "berkeleydb";
    version: "${package-version}";
    original-source-location: "";
    original-source-website: "http://www.oracle.com/technetwork/database/berkeleydb/downloads/index.html";
    license: "sleepycat";
    packager: "Vincent Povirk <madewokherd@gmail.com>";
}

x86 {
	set: {
		COMP="${COMP??vc10}";
		PLAT="x86";
		CONFIG="${CONFIG??Debug}";
	};

    compiler: "${COMP}";
    platform: "${PLAT}";
      
    targets: {
		"output\${COMP}\${PLAT}\${CONFIG}\libdb51.lib",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb51.exp",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb51.dll",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb_sql51.lib",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb_sql51.exp",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb_sql51.dll",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb_stl51.lib",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb_stl51.exp",
        "output\${COMP}\${PLAT}\${CONFIG}\libdb_stl51.dll",
        "output\${COMP}\${PLAT}\${CONFIG}\dbsql.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_archive.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_checkpoint.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_deadlock.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_dump.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_hotbackup.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_load.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_log_verify.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_printlog.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_recover.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_replicate.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_sql_codegen.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_stat.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_upgrade.exe",
        "output\${COMP}\${PLAT}\${CONFIG}\db_verify.exe"
		/*
        "build_windows\Win32\Release\libdb51.lib",
        "build_windows\Win32\Release\libdb51.exp",
        "build_windows\Win32\Release\libdb51.dll",
        "build_windows\Win32\Release\libdb_sql51.lib",
        "build_windows\Win32\Release\libdb_sql51.exp",
        "build_windows\Win32\Release\libdb_sql51.dll",
        "build_windows\Win32\Release\libdb_stl51.lib",
        "build_windows\Win32\Release\libdb_stl51.exp",
        "build_windows\Win32\Release\libdb_stl51.dll",
        "build_windows\Win32\Release\dbsql.exe",
        "build_windows\Win32\Release\db_archive.exe",
        "build_windows\Win32\Release\db_checkpoint.exe",
        "build_windows\Win32\Release\db_deadlock.exe",
        "build_windows\Win32\Release\db_dump.exe",
        "build_windows\Win32\Release\db_hotbackup.exe",
        "build_windows\Win32\Release\db_load.exe",
        "build_windows\Win32\Release\db_log_verify.exe",
        "build_windows\Win32\Release\db_printlog.exe",
        "build_windows\Win32\Release\db_recover.exe",
        "build_windows\Win32\Release\db_replicate.exe",
        "build_windows\Win32\Release\db_sql_codegen.exe",
        "build_windows\Win32\Release\db_stat.exe",
        "build_windows\Win32\Release\db_upgrade.exe",
        "build_windows\Win32\Release\db_verify.exe"
		*/
    };
      
    build-command:@"
		if ""${COMP}""==""vc10"" (
			msbuild /p:Platform=Win32 /p:Configuration=${CONFIG} build_windows\Berkeley_DB_vs2010.sln
		)
		if ""${COMP}""==""vc8"" (
			msbuild /p:Platform=Win32 /p:Configuration=${CONFIG} build_windows\Berkeley_DB.sln
		)
		mkdir output\${COMP}\${PLAT}\${CONFIG}\
		copy build_windows\Win32\${CONFIG}\libdb51.lib output\${COMP}\${PLAT}\${CONFIG}\libdb51.lib
		copy build_windows\Win32\${CONFIG}\libdb51.exp output\${COMP}\${PLAT}\${CONFIG}\libdb51.exp
		copy build_windows\Win32\${CONFIG}\libdb51.dll output\${COMP}\${PLAT}\${CONFIG}\libdb51.dll
		copy build_windows\Win32\${CONFIG}\libdb_sql51.lib output\${COMP}\${PLAT}\${CONFIG}\libdb_sql51.lib
		copy build_windows\Win32\${CONFIG}\libdb_sql51.exp output\${COMP}\${PLAT}\${CONFIG}\libdb_sql51.exp
		copy build_windows\Win32\${CONFIG}\libdb_sql51.dll output\${COMP}\${PLAT}\${CONFIG}\libdb_sql51.dll
		copy build_windows\Win32\${CONFIG}\libdb_stl51.lib output\${COMP}\${PLAT}\${CONFIG}\libdb_stl51.lib
		copy build_windows\Win32\${CONFIG}\libdb_stl51.exp output\${COMP}\${PLAT}\${CONFIG}\libdb_stl51.exp
		copy build_windows\Win32\${CONFIG}\libdb_stl51.dll output\${COMP}\${PLAT}\${CONFIG}\libdb_stl51.dll
		copy build_windows\Win32\${CONFIG}\dbsql.exe output\${COMP}\${PLAT}\${CONFIG}\dbsql.exe
		copy build_windows\Win32\${CONFIG}\db_archive.exe output\${COMP}\${PLAT}\${CONFIG}\db_archive.exe
		copy build_windows\Win32\${CONFIG}\db_checkpoint.exe output\${COMP}\${PLAT}\${CONFIG}\db_checkpoint.exe
		copy build_windows\Win32\${CONFIG}\db_deadlock.exe output\${COMP}\${PLAT}\${CONFIG}\db_deadlock.exe
		copy build_windows\Win32\${CONFIG}\db_dump.exe output\${COMP}\${PLAT}\${CONFIG}\db_dump.exe
		copy build_windows\Win32\${CONFIG}\db_hotbackup.exe output\${COMP}\${PLAT}\${CONFIG}\db_hotbackup.exe
		copy build_windows\Win32\${CONFIG}\db_load.exe output\${COMP}\${PLAT}\${CONFIG}\db_load.exe
		copy build_windows\Win32\${CONFIG}\db_log_verify.exe output\${COMP}\${PLAT}\${CONFIG}\db_log_verify.exe
		copy build_windows\Win32\${CONFIG}\db_printlog.exe output\${COMP}\${PLAT}\${CONFIG}\db_printlog.exe
		copy build_windows\Win32\${CONFIG}\db_recover.exe output\${COMP}\${PLAT}\${CONFIG}\db_recover.exe
		copy build_windows\Win32\${CONFIG}\db_replicate.exe output\${COMP}\${PLAT}\${CONFIG}\db_replicate.exe
		copy build_windows\Win32\${CONFIG}\db_sql_codegen.exe output\${COMP}\${PLAT}\${CONFIG}\db_sql_codegen.exe
		copy build_windows\Win32\${CONFIG}\db_stat.exe output\${COMP}\${PLAT}\${CONFIG}\db_stat.exe
		copy build_windows\Win32\${CONFIG}\db_upgrade.exe output\${COMP}\${PLAT}\${CONFIG}\db_upgrade.exe
		copy build_windows\Win32\${CONFIG}\db_verify.exe output\${COMP}\${PLAT}\${CONFIG}\db_verify.exe
		copy build_windows\Win32\${CONFIG}\ex_access.exe output\${COMP}\${PLAT}\${CONFIG}\ex_access.exe
    ";
      
    clean-command:@"
		rmdir /S /Q build_windows\Win32 2>NUL
	";
};

x64 {
	set: {
		COMP="${COMP??vc10}";
		PLAT="${PLAT??x64}";  //there's a reason for this oddity, I promise
		CONFIG="${CONFIG??Debug}";
	};

    compiler: "${COMP}";
    platform: "${PLAT}";
      
    targets: {
		"output\${COMP}\x64\${CONFIG}\libdb51.lib",
        "output\${COMP}\x64\${CONFIG}\libdb51.exp",
        "output\${COMP}\x64\${CONFIG}\libdb51.dll",
        "output\${COMP}\x64\${CONFIG}\libdb_sql51.lib",
        "output\${COMP}\x64\${CONFIG}\libdb_sql51.exp",
        "output\${COMP}\x64\${CONFIG}\libdb_sql51.dll",
        "output\${COMP}\x64\${CONFIG}\libdb_stl51.lib",
        "output\${COMP}\x64\${CONFIG}\libdb_stl51.exp",
        "output\${COMP}\x64\${CONFIG}\libdb_stl51.dll",
        "output\${COMP}\x64\${CONFIG}\dbsql.exe",
        "output\${COMP}\x64\${CONFIG}\db_archive.exe",
        "output\${COMP}\x64\${CONFIG}\db_checkpoint.exe",
        "output\${COMP}\x64\${CONFIG}\db_deadlock.exe",
        "output\${COMP}\x64\${CONFIG}\db_dump.exe",
        "output\${COMP}\x64\${CONFIG}\db_hotbackup.exe",
        "output\${COMP}\x64\${CONFIG}\db_load.exe",
        "output\${COMP}\x64\${CONFIG}\db_log_verify.exe",
        "output\${COMP}\x64\${CONFIG}\db_printlog.exe",
        "output\${COMP}\x64\${CONFIG}\db_recover.exe",
        "output\${COMP}\x64\${CONFIG}\db_replicate.exe",
        "output\${COMP}\x64\${CONFIG}\db_sql_codegen.exe",
        "output\${COMP}\x64\${CONFIG}\db_stat.exe",
        "output\${COMP}\x64\${CONFIG}\db_upgrade.exe",
        "output\${COMP}\x64\${CONFIG}\db_verify.exe"
    };
      
    build-command:@"
		if ""${COMP}""==""vc10"" (
			msbuild /p:Platform=x64 /p:Configuration=${CONFIG} build_windows\Berkeley_DB_vs2010.sln
		)
		if ""${COMP}""==""vc8"" (
			msbuild /p:Platform=x64 /p:Configuration=${CONFIG} build_windows\Berkeley_DB.sln
		)
		mkdir output\${COMP}\x64\${CONFIG}\
		copy build_windows\x64\${CONFIG}\libdb51.lib output\${COMP}\x64\${CONFIG}\libdb51.lib
		copy build_windows\x64\${CONFIG}\libdb51.exp output\${COMP}\x64\${CONFIG}\libdb51.exp
		copy build_windows\x64\${CONFIG}\libdb51.dll output\${COMP}\x64\${CONFIG}\libdb51.dll
		copy build_windows\x64\${CONFIG}\libdb_sql51.lib output\${COMP}\x64\${CONFIG}\libdb_sql51.lib
		copy build_windows\x64\${CONFIG}\libdb_sql51.exp output\${COMP}\x64\${CONFIG}\libdb_sql51.exp
		copy build_windows\x64\${CONFIG}\libdb_sql51.dll output\${COMP}\x64\${CONFIG}\libdb_sql51.dll
		copy build_windows\x64\${CONFIG}\libdb_stl51.lib output\${COMP}\x64\${CONFIG}\libdb_stl51.lib
		copy build_windows\x64\${CONFIG}\libdb_stl51.exp output\${COMP}\x64\${CONFIG}\libdb_stl51.exp
		copy build_windows\x64\${CONFIG}\libdb_stl51.dll output\${COMP}\x64\${CONFIG}\libdb_stl51.dll
		copy build_windows\x64\${CONFIG}\dbsql.exe output\${COMP}\x64\${CONFIG}\dbsql.exe
		copy build_windows\x64\${CONFIG}\db_archive.exe output\${COMP}\x64\${CONFIG}\db_archive.exe
		copy build_windows\x64\${CONFIG}\db_checkpoint.exe output\${COMP}\x64\${CONFIG}\db_checkpoint.exe
		copy build_windows\x64\${CONFIG}\db_deadlock.exe output\${COMP}\x64\${CONFIG}\db_deadlock.exe
		copy build_windows\x64\${CONFIG}\db_dump.exe output\${COMP}\x64\${CONFIG}\db_dump.exe
		copy build_windows\x64\${CONFIG}\db_hotbackup.exe output\${COMP}\x64\${CONFIG}\db_hotbackup.exe
		copy build_windows\x64\${CONFIG}\db_load.exe output\${COMP}\x64\${CONFIG}\db_load.exe
		copy build_windows\x64\${CONFIG}\db_log_verify.exe output\${COMP}\x64\${CONFIG}\db_log_verify.exe
		copy build_windows\x64\${CONFIG}\db_printlog.exe output\${COMP}\x64\${CONFIG}\db_printlog.exe
		copy build_windows\x64\${CONFIG}\db_recover.exe output\${COMP}\x64\${CONFIG}\db_recover.exe
		copy build_windows\x64\${CONFIG}\db_replicate.exe output\${COMP}\x64\${CONFIG}\db_replicate.exe
		copy build_windows\x64\${CONFIG}\db_sql_codegen.exe output\${COMP}\x64\${CONFIG}\db_sql_codegen.exe
		copy build_windows\x64\${CONFIG}\db_stat.exe output\${COMP}\x64\${CONFIG}\db_stat.exe
		copy build_windows\x64\${CONFIG}\db_upgrade.exe output\${COMP}\x64\${CONFIG}\db_upgrade.exe
		copy build_windows\x64\${CONFIG}\db_verify.exe output\${COMP}\x64\${CONFIG}\db_verify.exe
		copy build_windows\x64\${CONFIG}\ex_access.exe output\${COMP}\x64\${CONFIG}\ex_access.exe
    ";
      
    clean-command:@"
		rmdir /S /Q build_windows\x64 2>NUL
	";
};

common-test {
    build-command:@"
        if exist *.db del /Q *.db
        dir /b | ${outdir}ex_access || goto failed
        ${outdir}db_verify access.db || goto failed
        ${outdir}db_dump access.db > access.dump || goto failed
        ${outdir}db_load test.db < access.dump || goto failed
        ${outdir}db_verify test.db || goto failed
        ${outdir}db_dump test.db > test.dump || goto failed
        echo n|comp /A /L access.dump test.dump || goto failed
        echo.
        del /Q *.db *.dump
        rmdir /S /Q access.db-journal >nul 2>nul
    ";

	/*
    clean-command:@"
        del /Q *.db *.dump
        rmdir /S /Q access.db-journal
    ";
	*/
};

/*
test-x86 {
	
    uses: { common-test };

    set: {
        outdir=@"build_windows\Win32\Release\";
    };
};
*/

release {
	set: {
		COMP="${COMP??vc8, vc10}";
		PLAT="${PLAT??x86, x64}";
		CONFIG="Release";
	};

	/*
	There is a problem in vc8 (VS 2005) where MSBUILD in the x64 envirinment
	contains incorrect include paths by default.  The easiest solution to this
	is to use the x86_64 cross-compiler tools instead, by setting the environ
	to x86 for the x64 build in vc8.
	*/
    build-command: @"
		for %%A in (${COMP}) do (
			for %%B in (${PLAT}) do (
				if ""%%A""==""vc8"" (
					ptk %%B --COMP=%%A --PLAT=x86 --nologo
				) else (
					ptk %%B --COMP=%%A --nologo
				)
			)
		)
    ";
};

test {
	set: {
		COMP="${COMP??vc8, vc10}";
		PLAT="${PLAT??x86, x64}";
	};

    uses: { release };

    build-command: @"
		for %%A in (${COMP}) do (
			for %%B in (${PLAT}) do (
				ptk common-test --outdir=.\output\%%A\%%B\Release\ --nologo
			)
		)
    ";

	/*
    clean-command:@"
        ptk clean test-x86
    ";
	*/
};

package {
	set: {
		COMP="${COMP??vc8, vc10}";
		PLAT="${PLAT??x86, x64}";
	};

    uses: { release };

    build-command: @"
		for %%A in (${COMP}) do (
			for %%B in (${PLAT}) do (
				autopackage.exe COPKG\berkeleydb.autopkg --arc=%%B --flav=%%A
			)
		)
    ";
};
